---
import { readItems, readSingleton } from "@directus/sdk";
import { Client } from "@/lib/directus";
import Markdown from "@/components/ui/Markdown.astro";
import Plus from "@/components/ui/icons/Plus.astro";
import Minus from "@/components/ui/icons/Minus.astro";
import { LEPORELLO_BG } from "@/lib/consts";
import WorkDetails from "../ui/WorkDetails.astro";

let leporello;
let lepWork;
try {
  leporello = await Client.request(readSingleton("leporello"));
  const lepWorkRaw = await Client.request(
    readItems("works", {
      filter: {
        inventory_id: { _eq: LEPORELLO_BG },
        status: { _eq: "published" },
      },
      limit: 1,
    }),
  );
  if (lepWorkRaw.length > 0) lepWork = lepWorkRaw[0];
} catch (e) {
  return new Response(null, { status: 404 });
}
---

<div class="container" data-blocks={JSON.stringify(leporello.blocks)}>
  <div id="leporello-viewer">
    {
      lepWork && (
        <div id="leporello-work">
          <WorkDetails
            work={lepWork}
            tagMap={{ taxonomy: [], series: [], medium: [] }}
          />
          <a href={`/order-original/?id=${lepWork.id}&expanded=true`}>
            Learn more
          </a>
        </div>
      )
    }
    {
      leporello.blocks.map((block) => (
        <div id={block.id} class="overlay">
          <a
            href={
              block.url
                ? block.url
                : block.work
                  ? `/order-original/?id=${block.work?.key}&expanded=true`
                  : "#"
            }
          />
          {block.description && (
            <div class="detail mono">
              <Markdown content={block.description} />
            </div>
          )}
        </div>
      ))
    }
  </div>
  <div id="controls">
    <button id="zoom-in"><Plus /> </button>
    <button id="zoom-out"><Minus /></button>
  </div>
  <div id="leporello-navigator-container">
    <div id="leporello-navigator"></div>
  </div>
</div>

<style>
  #leporello-viewer,
  .container {
    width: 100vw;
    height: 100dvh;
  }

  #controls {
    position: absolute;
    top: var(--spacing--base);
    right: var(--spacing--base);
    display: flex;
    flex-direction: column;
    gap: calc(0.5 * var(--spacing--base));

    button {
      border: 1px solid var(--color-white);
      width: calc(2 * var(--spacing--base));
      height: calc(2 * var(--spacing--base));
      padding: calc(0.25 * var(--spacing--base));

      fill: white;
      display: flex;
      align-items: center;
      justify-content: center;

      &:hover {
        background-color: rgba(127, 127, 127, 0.25);
      }
    }
  }

  #leporello-navigator-container {
    position: absolute;
    width: calc(100vw - 9 * var(--spacing--base));
    left: calc(7 * var(--spacing--base));
    bottom: var(--spacing--base);
    right: var(--spacing--base);
    aspect-ratio: 161688 / 3900;
    border: 1px solid var(--color-white);
  }

  #leporello-navigator {
    width: 100%;
    height: 100%;
  }

  .overlay {
    visibility: hidden;
    border: 1px dashed rgba(255, 255, 255, 0.5);
    transition:
      background-color 0.3s ease,
      border 0.3s ease;
    position: relative;

    &.loaded {
      visibility: visible;
    }

    &:hover {
      border: 1px solid white;
      background-color: rgba(127, 127, 127, 0.25);
      .detail {
        display: block;
      }
    }

    a {
      display: block;
      width: 100%;
      height: 100%;
    }

    .detail {
      position: absolute;
      display: none;
      padding-top: calc(0.5 * var(--spacing--base));
    }
  }
</style>

<script src="./leporello.js"></script>
