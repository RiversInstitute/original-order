---
import { readFile } from "@directus/sdk";

import { Client } from "@/lib/directus";
import type { DirectusFileStub } from "@/lib/types";

interface Props {
  asset: string | DirectusFileStub;
  alt?: string;
  withDescription?: boolean;
  width?: number;
  height?: number;
  lightboxGallery?: string;
}

const { asset, alt, withDescription, width, height, lightboxGallery } =
  Astro.props;
const file =
  typeof asset === "string"
    ? await Client.request(
        readFile(asset, {
          fields: ["id", "width", "height", "description"],
        }),
      )
    : asset;

let derivedWidth = width;
let derivedHeight = height;
if (!width && !height) {
  derivedWidth = 1800;
  derivedHeight = 1800;
}
---

<figure
  {...lightboxGallery
    ? {
        "data-lightbox-gallery": lightboxGallery,
        "data-lightbox-src": `/assets/${file.id}?width=2000&height=2000&fit=inside`,
        "data-lightbox-caption": file?.description ?? "",
      }
    : {}}
>
  <img
    loading="lazy"
    src={`/assets/${file.id}?${derivedWidth ? `&width=${derivedWidth}` : ""}${derivedHeight ? `&height=${derivedHeight}` : ""}&fit=inside`}
    alt={alt}
    width={file?.width}
    draggable="false"
    height={file?.height}
  />
  {
    withDescription && file?.description && (
      <figcaption class="mono caption">{file.description}</figcaption>
    )
  }
</figure>

<style>
  figcaption {
    margin-top: calc(0.5 * var(--spacing--base));
    color: var(--color--grey-dark);
  }

  [data-lightbox-gallery] {
    cursor: pointer;
  }
</style>

<script>
  import type { OpenLightboxEvent } from "@/lib/consts";

  document
    .querySelectorAll("figure[data-lightbox-gallery]")
    .forEach((figure) => {
      figure.addEventListener("click", () => {
        const src = figure.getAttribute("data-lightbox-src");
        const gallery = figure.getAttribute("data-lightbox-gallery");
        const caption = figure.getAttribute("data-lightbox-caption") || "";
        if (src) {
          const event = new CustomEvent<OpenLightboxEvent>("openLightbox", {
            detail: {
              src,
              caption,
              gallery,
            },
          });
          document.dispatchEvent(event);
        }
      });
    });
</script>
