---
import { readFile } from "@directus/sdk";

import { Client } from "@/lib/directus";
import type { DirectusFileStub } from "@/lib/types";

interface Props {
  asset: string | DirectusFileStub;
  alt?: string;
  withDescription?: boolean;
  width?: number;
  height?: number;
}

const { asset, alt, withDescription, width, height } = Astro.props;
const file =
  typeof asset === "string"
    ? await Client.request(
        readFile(asset, {
          fields: ["id", "width", "height", "description"],
        }),
      )
    : asset;

let derivedWidth = width;
let derivedHeight = height;
if (!width && !height) {
  derivedWidth = 1800;
  derivedHeight = 1800;
}
---

<figure>
  <img
    loading="lazy"
    src={`/assets/${file.id}?${derivedWidth ? `&width=${derivedWidth}` : ""}${derivedHeight ? `&height=${derivedHeight}` : ""}&fit=inside`}
    alt={alt}
    width={file?.width}
    draggable="false"
    height={file?.height}
  />
  {
    withDescription && file?.description && (
      <figcaption class="mono caption">{file.description}</figcaption>
    )
  }
</figure>

<style>
  figcaption {
    margin-top: calc(0.5 * var(--spacing--base));
    color: var(--color--grey-dark);
  }
</style>
