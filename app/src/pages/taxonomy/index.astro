---
import Layout from "@/layouts/Layout.astro";
import Nav from "@/components/Nav.astro";
import ContentWrapper from "@/components/ContentWrapper.astro";
import TagNav from "@/components/TagNav.astro";

import { readItems } from "@directus/sdk";
import { Client } from "@/lib/directus";
import TagList from "@/components/TagList.astro";

const taxonomies = await Client.request(
  readItems("taxonomy", {
    fields: ["id", "title"],
    limit: -1,
    sort: ["title"],
  }),
);

const works = await Client.request(
  readItems("works_taxonomy", {
    fields: ["id", "taxonomy_id"],
    limit: -1,
  }),
);

const count: Record<string, number> = {};
taxonomies.forEach(
  (tag) =>
    (count[tag.id] = works.filter(
      (work) => work.taxonomy_id === tag.id,
    ).length),
);
---

<Layout pageTitle="Taxonomy">
  <Nav />
  <ContentWrapper>
    <TagNav activeTag="taxonomy" />
    <TagList tags={taxonomies} tagCount={count} urlBase="taxonomy" />
  </ContentWrapper>
</Layout>
